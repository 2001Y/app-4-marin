# 2025-10-03 14:53 ログタイムライン

1. ✅ **アプリ起動直後** – `MessageSyncPipeline` と `AppDelegate` が初期化、UIScene を構成。`CloudKitChatManager` が起動し、環境情報とリモート通知登録を完了。
2. ✅ **レガシーデータ診断** – `share` カテゴリの AUTO RESET シーケンスが実行され、レガシーゾーンや未同期メッセージは存在しないと判定。理想スキーマチェックも問題なしで完了。
3. ✅ **サブスクリプション整備** – private / shared 両 DB 向けに `Ensuring database subscription` が実行され、`CKSyncEngine` が private/shared の 2 つのエンジンで開始。初回 `WillFetchChanges`／`DidFetchChanges` で状態が永続化される。
4. ✅ **チュートリアルルーム準備** – `room_AF6F13C7` のゾーンが解決され、`MessageStore` が手動リフレッシュを要求。シードされた 8 件のチュートリアルメッセージが `MessageSyncPipeline` で作成・UI へ反映される。
5. ⚠️ **シグナル系初期化** – ルーム購読を張る過程で `resolveZone(signal)` が private scope を返しつつ `ensureOwnerParticipant` を多重に呼び、オーナー参加者を追加しようと試行。以後も push を受けるたびに同じハンドラが走り続ける。
6. ⚠️ **Push→Sync ループ** – 複数の CloudKit push (`CKNotificationType` が 2/4) を受信するたびに `Manual checkForUpdates` と `fetchChanges` が繰り返され、private/shared の両エンジンで pending=1 の状態が続く。
7. ⚠️ **UI 操作** – `RootView` で `openChat room_AF6F13C7` が呼ばれ、`MessageStore` が 9 件（シード + 1）をロード。チャット画面が表示され `P2PController.startIfNeeded` が `my=_203df8f remote=_9e7af71` で接続を開始。
8. ❌ **WebRTC 準備** – ICE サーバ構成、トランシーバ追加、ローカルカメラ開始を試みるが `FigCaptureSourceRemote` で `err=-17281` が発生。`ICE gathering state` は progressing。
9. ❌ **シグナル書き込み競合** – Mailbox 更新フェーズで `Failed to publish ICE candidate` が多数発生。原因は `Zone Busy` および `Server Record Changed`（op-lock 競合）で、`ensureOwnerParticipant` も同じタイミングで `Zone Busy` を返している。
10. ❌ **プロフィール取得失敗** – `ChatView` が相手プロフィールをリフレッシュしようとするが `CKError Unknown Item` で失敗。以後も push 受信のたびに同じエラーが出力される。
11. ❌ **終盤の挙動** – push 受信→手動同期→`resolveZone(signal)`→`ensureOwnerParticipant`→購読張り直しというループが継続し、`Room subscription setup completed` ログが繰り返し出力されている。

> ⚠️ 注: ログ終盤は大半が同じ 4 ステップ（push → 手動同期 → owner participant 追加試行 → zone subscription 再設定）の繰り返しで、根本的なシグナリング競合が解消されていないことを示唆しています。
