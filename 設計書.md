# MarinEE â€• 1 å¯¾ 1 ãƒãƒ£ãƒƒãƒˆ & "ã‚¢ãƒ—ãƒªå†…ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç„¡éŸ³ãƒ“ãƒ‡ã‚ª" å®Œå…¨è©³ç´°è¨­è¨ˆæ›¸

(ã‚µãƒ¼ãƒãƒ¼é‹ç”¨ã‚¼ãƒ­ / CloudKit + WebRTC-STUN ã®ã¿)

iOS17 ä»¥ä¸Šæ—¥ç‹ã§ãã‚Œã°è‰¯ã„ã®ã§ã€æœ€æ–°ã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ã€ã§ãã‚‹ã ã‘ãƒ¢ãƒ€ãƒ³ãªã‚¹ãƒãƒ¼ãƒˆãªå®Ÿè£…ã‚’ãŠè¡Œã†ã€‚

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé››å½¢

### æ‰‹é †

| é …ç›®                    | å€¤                                     |
| ----------------------- | -------------------------------------- |
| File â–¸ New â–¸ App        | -                                      |
| Product Name            | MarinEE                                |
| Organization Identifier | com.<ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³> ä¾‹: com.example |
| Interface               | SwiftUI                                |
| Language                | Swift                                  |
| Storage                 | SwiftData                              |
| âœ… Host in CloudKit     | å¿…é ˆ                                   |

### Capabilities & æ¨©é™

| ã‚«ãƒ†ã‚´ãƒª           | ON                                                    | OFF                  | ç†ç”±                  |
| ------------------ | ----------------------------------------------------- | -------------------- | --------------------- |
| iCloud             | CloudKit / Private DB                                 | -                    | ãƒ‡ãƒ¼ã‚¿åŒæœŸ            |
| Push Notifications | Dev + Prod                                            | -                    | ã‚µã‚¤ãƒ¬ãƒ³ãƒˆé€šçŸ¥        |
| Background Modes   | Remote notifications                                  | Audio / PiP ãªã©å…¨ã¦ | BG ã¯é€šçŸ¥ã®ã¿         |
| Privacy.plist      | NSCameraUsageDescription = "ç„¡éŸ³ãƒ“ãƒ‡ã‚ªé€šè©±ã§æ˜ åƒå…±æœ‰" | ãƒã‚¤ã‚¯èª¬æ˜ã‚­ãƒ¼ãªã—   | éŸ³å£°é€ä¿¡ã—ãªã„        |
| Sign In            | Keychain è‡ªå‹•                                         | -                    | remoteUserID ä¿è­·ä¿å­˜ |

### ä¾å­˜ Swift Package

- https://github.com/stasel/WebRTC.git (from 109.0.0)

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 2.1 SwiftData

```swift
@Model
final class Message: Identifiable {
    @Attribute(.unique) var id: UUID
    var roomID: String
    var senderID: String  // è‡ªåˆ† or ç›¸æ‰‹
    var body: String
    var createdAt: Date
    var isSent: Bool
}
```

### 2.2 CloudKit ã‚¹ã‚­ãƒ¼ãƒ

| Record Type    | Fields                                          | ç”¨é€”     |
| -------------- | ----------------------------------------------- | -------- |
| MessageCK      | roomID:String(index), senderID, body, createdAt | ãƒ†ã‚­ã‚¹ãƒˆ |
| CallSessionCK  | roomID(PK), offer:Data?, answer:Data?           | SDP      |
| IceCandidateCK | roomID(index), sdpMid, sdpMLineIndex, candidate | ICE      |
| PresenceCK     | roomID(index), userID, expires:Date             | 30s TTL  |

ã™ã¹ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DB / ChatZone

roomID = HMAC-SHA256(myID+remoteID) ã§ 64 æ¡ HEXã€‚

---

## 3. ã‚¢ãƒ—ãƒªæ§‹æˆãƒ“ãƒ¥ãƒ¼

```
WindowGroup
â””â”€ RootSwitcher
    â”œâ”€ PairingView     â† åˆå›
    â””â”€ ChatView
        â””â”€ FloatingVideoOverlay (å¸¸é§)
```

### 3.1 PairingView

```swift
struct PairingView: View {
    @AppStorage("remoteUserID") private var remoteUserID = ""
    @State private var partnerID = ""

    var body: some View {
        VStack(spacing: 32) {
            TextField("ç›¸æ‰‹ã® Apple ID / é›»è©±ç•ªå·", text: $partnerID)
                .textFieldStyle(.roundedBorder)
            Button("ç™»éŒ²ã—ã¦é–‹å§‹") {
                remoteUserID = partnerID.trimmingCharacters(in: .whitespaces)
            }
            .disabled(partnerID.isEmpty)
        }
        .padding()
    }
}
```

### 3.2 RootSwitcher

```swift
@main
struct MarinEEApp: App {
    @AppStorage("remoteUserID") private var remoteUserID = ""

    var body: some Scene {
        WindowGroup {
            if remoteUserID.isEmpty {
                PairingView()
            } else {
                ChatView()
            }
        }
    }
}
```

---

## 4. Pushãƒ»åŒæœŸåŸºç›¤

### 4.1 AppDelegate

```swift
final class AppDelegate: NSObject, UIApplicationDelegate, UNUserNotificationCenterDelegate {

    func application(_ app: UIApplication,
                     didFinishLaunchingWithOptions _: [UIApplication.LaunchOptionsKey: Any]? = nil) -> Bool {
        UNUserNotificationCenter.current().delegate = self
        app.registerForRemoteNotifications()
        Task { try? await CKSync.installSubscriptions() }
        return true
    }

    func application(_ app: UIApplication,
                     didReceiveRemoteNotification userInfo: [AnyHashable: Any]) async
           -> UIBackgroundFetchResult {
        return await CKSync.handlePush(userInfo)
    }
}
```

### 4.2 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ

```swift
enum CKSync {
    static func installSubscriptions() async throws {
        let db = CKContainer.default().privateCloudDatabase
        for (type, id) in [("MessageCK","msg-sub"),
                           ("CallSessionCK","sig-sub"),
                           ("IceCandidateCK","ice-sub"),
                           ("PresenceCK","pre-sub")] {
            let sub = CKQuerySubscription(recordType: type,
                                         predicate: .init(value: true),
                                         subscriptionID: id,
                                         options: .firesOnRecordCreation)
            let info = CKSubscription.NotificationInfo()
            info.shouldSendContentAvailable = true
            sub.notificationInfo = info
            try await db.save(sub)
        }
    }
```

### 4.3 Push å—ä¿¡ â†’ å·®åˆ†åæ˜ 

```swift
    static func handlePush(_ userInfo: [AnyHashable: Any]) async -> UIBackgroundFetchResult {
        let db = CKContainer.default().privateCloudDatabase
        let changes = try? await db.afetchAllChanges()  // zone changes helper
        await MainActor.run {
            changes?.forEach { record in
                if let msg = MessageMapper.from(record) {
                    modelContext.insert(msg)
                }
                P2PController.shared.ingest(record)  // SDP / ICE / Presence
            }
        }
        return .newData
    }
}
```

---

## 5. ãƒãƒ£ãƒƒãƒˆå‡¦ç†

### 5.1 é€ä¿¡

```swift
func sendMessage(_ text: String) {
    let m = Message(id: .init(),
                    roomID: roomID,
                    senderID: myID,
                    body: text,
                    createdAt: .now,
                    isSent: false)
    modelContext.insert(m)
    Task.detached {
        try await CKSync.saveMessage(m)
        await MainActor.run { m.isSent = true }
    }
}
```

### 5.2 ChatView UI

```swift
struct ChatView: View {
    @Query(filter: #Predicate<Message> { $0.roomID == roomID },
           sort: \.createdAt) var messages: [Message]
    @State private var text = ""

    var body: some View {
        ZStack(alignment: .topTrailing) {
            VStack {
                ScrollViewReader { proxy in
                    ScrollView {
                        LazyVStack {
                            ForEach(messages) { bubble(for: $0) }
                        }
                    }
                    .onChange(of: messages.last?.id) { id in
                        if let id {
                            proxy.scrollTo(id, anchor: .bottom)
                        }
                    }
                }
                HStack {
                    TextField("Message", text: $text)
                    Button("Send") {
                        sendMessage(text)
                        text = ""
                    }
                    .disabled(text.isEmpty)
                }
                .padding()
            }
            FloatingVideoOverlay()
        }
        .onAppear { P2PController.shared.startIfNeeded() }
        .onDisappear { P2PController.shared.close() }
    }
}
```

---

## 6. P2PControllerï¼ˆWebRTC + Presenceï¼‰

```swift
@MainActor
final class P2PController: ObservableObject {
    enum State { case idle, connecting, connected, failed }
    @Published private(set) var state: State = .idle
    @Published var localTrack: RTCVideoTrack?
    @Published var remoteTrack: RTCVideoTrack?

    private var pc: RTCPeerConnection!
    private var capturer: RTCCameraVideoCapturer!
    private var presenceTimer: AnyCancellable?
}
```

### 6.1 èµ·å‹• & ã‚«ãƒ¡ãƒ©

```swift
func startIfNeeded() {
    guard state == .idle else { return }
    state = .connecting
    setupPeer()
    startLocalCamera()
    schedulePresence()
    maybeExchangeSDP()  // CloudKit çµŒç”± (Host/Guest è‡ªå‹•åˆ¤å®š)
}
```

### 6.2 PeerConnection & Delegates

```swift
func setupPeer() {
    let f = RTCPeerConnectionFactory()
    var cfg = RTCConfiguration()
    cfg.iceServers = [RTCIceServer(urlStrings: ["stun:stun.l.google.com:19302"])]
    pc = f.peerConnection(with: cfg, constraints: .init(), delegate: self)
}

func startLocalCamera() {
    let f = RTCPeerConnectionFactory()
    let source = f.videoSource()
    capturer = RTCCameraVideoCapturer(delegate: source)
    localTrack = f.videoTrack(with: source, trackId: "local0")
    let ms = f.mediaStream(with: "stream0")
    ms.addVideoTrack(localTrack!)
    pc.add(ms)

    guard
        let device = RTCCameraVideoCapturer.captureDevices()
                     .first(where: { $0.position == .front }),
        let format = RTCCameraVideoCapturer.supportedFormats(for: device)
                     .first(where: { CMFormatDescriptionGetDimensions($0.formatDescription).width >= 640 }),
        let fps = format.videoSupportedFrameRateRanges.first?.maxFrameRate
    else { return }

    capturer.startCapture(with: device, format: format, fps: Int(fps/2))
}
```

### Delegate æŠœç²‹

```swift
extension P2PController: RTCPeerConnectionDelegate {
    func peerConnection(_ pc: RTCPeerConnection, didAdd stream: RTCMediaStream) {
        if let track = stream.videoTracks.first {
            remoteTrack = track
            if localTrack != nil {
                FloatingVideoOverlayBridge.activate()
            }
        }
    }

    func peerConnection(_ pc: RTCPeerConnection,
                        didChange state: RTCPeerConnectionState) {
        self.state = (state == .connected) ? .connected
                   : (state == .failed ? .failed : self.state)
    }

    func peerConnection(_ pc: RTCPeerConnection,
                        didGenerate candidate: RTCIceCandidate) {
        Task {
            try? await CKSync.saveCandidate(candidate, roomID: roomID)
        }
    }
}
```

### 6.3 Presence

```swift
func schedulePresence() {
    presenceTimer = Timer.publish(every: 25, on: .main, in: .common)
        .autoconnect()
        .sink { _ in
            CKSync.refreshPresence(roomID, myID)
        }
}
```

expires = now + 30ã€‚å¤±åŠ¹æ¤œçŸ¥ã§ close() ã‚’å‘¼ã¶ã€‚

### 6.4 çµ‚äº†

```swift
func close() {
    presenceTimer?.cancel()
    capturer.stopCapture()
    pc?.close()
    localTrack = nil
    remoteTrack = nil
    state = .idle
}
```

---

## 7. FloatingVideoOverlay â€• ã‚¢ãƒ—ãƒªå†… PiP

### 7.1 UIViewRepresentable

```swift
struct RTCVideoView: UIViewRepresentable {
    let track: RTCVideoTrack

    func makeUIView(context: Context) -> RTCMTLVideoView {
        RTCMTLVideoView()
    }

    func updateUIView(_ ui: RTCMTLVideoView, context: Context) {
        track.add(ui)
    }
}
```

### 7.2 ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤

```swift
struct FloatingVideoOverlay: View {
    @ObservedObject private var p2p = P2PController.shared
    @State private var offset: CGSize = .zero
    @State private var isExpanded = false

    var body: some View {
        if let remote = p2p.remoteTrack,
           let local = p2p.localTrack,
           p2p.state == .connected {

            ZStack(alignment: .topTrailing) {
                RTCVideoView(track: remote)
                    .aspectRatio(9/16, contentMode: .fill)
                    .clipped()

                RTCVideoView(track: local)
                    .frame(width: 96, height: 128)
                    .clipShape(RoundedRectangle(cornerRadius: 8))
                    .padding(8)
            }
            .frame(width: isExpanded ? 240 : 140,
                   height: isExpanded ? 320 : 200)
            .background(.black.opacity(0.6))
            .clipShape(RoundedRectangle(cornerRadius: 12))
            .shadow(radius: 4)
            .offset(offset)
            .gesture(DragGesture().onChanged { offset = $0.translation })
            .onTapGesture {
                withAnimation(.spring()) {
                    isExpanded.toggle()
                }
            }
            .padding(16)
            .transition(.scale.combined(with: .opacity))
        }
    }
}
```

---

## 8. FaceTime æ‰‹å‹•ç™ºä¿¡

```swift
struct FaceTimeButton: View {
    @Environment(\.openURL) private var openURL
    let callee: String

    var body: some View {
        Button {
            P2PController.shared.close()  // ã‚¨ã‚³ãƒ¼æŠ‘æ­¢
            openURL(URL(string: "facetime://\(callee)")!)
        } label: {
            Image(systemName: "video.circle.fill")
        }
    }
}
```

---

## 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼

| é …ç›®         | å†…å®¹                                             |
| ------------ | ------------------------------------------------ |
| ã‚·ã‚°ãƒŠãƒªãƒ³ã‚° | CloudKit TLS + ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ DB                   |
| ãƒ¡ãƒ‡ã‚£ã‚¢     | WebRTC DTLS-SRTPï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æš—å·åŒ–ï¼‰       |
| åé›†ãƒ‡ãƒ¼ã‚¿   | ã‚«ãƒ¡ãƒ©æ˜ åƒã®ã¿ãƒ»éŸ³å£°ã‚¼ãƒ­                         |
| ä¿å­˜         | remoteUserID ã‚’ Keychain (ThisDeviceOnly) ã«æ ¼ç´ |
| ç¬¬ä¸‰è€…è»¢é€   | ãªã—ï¼ˆP2P ç›´æ¥ï¼‰                                 |

---

## 10. ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

1. åˆå›ãƒšã‚¢ãƒªãƒ³ã‚° â†’ ChatView ã¸é·ç§»
2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ â†’ ãƒ­ãƒ¼ã‚«ãƒ«å³è¡¨ç¤º â†’ ç›¸æ‰‹ç«¯æœ«ã¸ push â†’ UI åæ˜ 
3. åŒæ–¹ ChatView è¡¨ç¤ºã§ 1ã€œ2 ç§’ä»¥å†…ã«ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ“ãƒ‡ã‚ªå‡ºç¾
4. ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚° â†’ ä½ç½®ä¿æŒã€ã‚¿ãƒƒãƒ— â†’ æ‹¡å¤§ç¸®å°
5. ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ç§»å‹• â†’ æ¥ç¶šåœæ­¢ / ã‚«ãƒ¡ãƒ©æ¶ˆç¯ â†’ å¾©å¸°ã§è‡ªå‹•å†æ¥ç¶š
6. ãƒã‚¤ã‚¯æ¨©é™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒä¸€åˆ‡å‡ºãªã„
7. FaceTime ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§ãƒ“ãƒ‡ã‚ªé–‰ã˜ã¦ã‹ã‚‰ FaceTime èµ·å‹•

## 11. ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â€• æ¨ªã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ â†’ ãƒ’ãƒ¼ãƒ­ãƒ¼é·ç§» â†’ ã‚ºãƒ¼ãƒ ï¼ä¸€æ‹¬ä¿å­˜ (iOS 17+)

### 11.1 æ©Ÿèƒ½æ¦‚è¦

- **ç›®çš„**: ãƒãƒ£ãƒƒãƒˆå†…ã‚„ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰ã‚¿ãƒƒãƒ—ã—ãŸç”»åƒã‚’ã€ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã§â€œãƒŒãƒ«ãƒƒâ€ã¨æ‹¡å¤§è¡¨ç¤ºã—ã€æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã§ä»–ç”»åƒã¸ç§»å‹•ã§ãã‚‹ UI ã‚’å®Ÿç¾ã™ã‚‹ã€‚
- **å¯¾è±¡ OS**: iOS 17 ä»¥é™ã€‚
- **ç‰¹å¾´**:
  1. è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦ã€‚SwiftUI ç´”æ­£ API 100%ã€‚
  2. `NavigationTransition(.zoom)` ã«ã‚ˆã‚‹ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
  3. `ScrollTargetBehavior(.viewAligned)` ã® Filmstrip ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã€‚
  4. ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ  + ãƒ‰ãƒ©ãƒƒã‚°ã§é–²è¦§ã€‚æ‹¡å¤§ç‡ 1 ä»¥ä¸‹ã§å…ƒä½ç½®ã«è‡ªå‹•ãƒªã‚»ãƒƒãƒˆã€‚
  5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ 1 ã¤ã§ã€å˜æ•°ï¼è¤‡æ•°ã‚’è‡ªå‹•åˆ¤å®šã—ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã€‚

### 11.2 ç”»é¢æ§‹æˆãƒ»é·ç§»

```mermaid
flowchart TD;
    A[HorizontalSliderView] -- tap(img) --> B[FullScreenPreviewView];
    B -- drag >100pt å³ --> A;
```

- `NavigationStack` ã‚’ç”¨ã„ã€`NavigationLink(value:)` ã§ `Int` å‹ index ã‚’ `path` ã«æŠ•å…¥ã€‚
- `navigationDestination(for: Int.self)` ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å—ã‘å–ã‚Šã€`FullScreenPreviewView` ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã€‚
- ãƒ’ãƒ¼ãƒ­ãƒ¼åŠ¹æœã¯ `.navigationTransition(.zoom)` ã§å®Ÿç¾ã—ã€ã‚³ãƒ¼ãƒ‰ 1 è¡Œã§å®Œçµã€‚

### 11.3 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨è²¬å‹™

| ãƒ•ã‚¡ã‚¤ãƒ«                       | å‹                      | è²¬å‹™                                                                               |
| ------------------------------ | ----------------------- | ---------------------------------------------------------------------------------- |
| `ImagePreviewComponents.swift` | `ImageSliderRoot`       | ãƒ«ãƒ¼ãƒˆã€‚`UIImage` é…åˆ—ã‚’å—ã‘å–ã‚Šã€`NavigationStack` ã‚’æ§‹æˆã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚ |
|                                | `HorizontalSliderView`  | æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚µãƒ ãƒã‚¤ãƒ«ã€‚`NavigationLink` ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸é·ç§»ã€‚                      |
|                                | `FullScreenPreviewView` | `TabView(.page)` + ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ã€‚å³ãƒ‰ãƒ©ãƒƒã‚° >100pt ã§é–‰ã˜ã‚‹ã€‚                      |
|                                | `ZoomableImage`         | `PhaseAnimator` + `ZoomGestureModifier` ã§ã‚ºãƒ¼ãƒ ï¼ãƒ‰ãƒ©ãƒƒã‚°å®Ÿè£…ã€‚                   |
|                                | `ZoomGestureModifier`   | `MagnificationGesture` & `DragGesture` ã‚’åˆæˆã—ã€ç§»å‹•ãƒ»ç¸®å°åˆ¤å®šã€‚                  |

### 11.4 ä¿å­˜å‡¦ç†

- å˜ä¸€ç”»åƒ: ç›´æ¥ `UIImageWriteToSavedPhotosAlbum`ã€‚
- è¤‡æ•°ç”»åƒ: ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆ â†’ ãƒ«ãƒ¼ãƒ—ä¿å­˜ã€‚
- **Info.plist** ã« `NSPhotoLibraryAddUsageDescription` ã‚’è¿½åŠ ã—ã€æ–‡è¨€ã€Œã‚¢ãƒ«ãƒãƒ ã¸ç”»åƒã‚’ä¿å­˜ã—ã¾ã™ã€ã‚’è¨­å®šã€‚

### 11.5 ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (è¿½åŠ )

1. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‹ã‚‰ç”»åƒã‚¿ãƒƒãƒ— â†’ ãƒ’ãƒ¼ãƒ­ãƒ¼æ‹¡å¤§å¾Œã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”»åƒãŒã‚¹ãƒ ãƒ¼ã‚ºã«ã‚ºãƒ¼ãƒ é€£æºã€‚
2. æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒšãƒ¼ã‚¸é€ã‚Š â†’ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹ã€‚
3. ãƒ”ãƒ³ãƒã‚¢ã‚¦ãƒˆ >1.5 å€ â†’ ç”»åƒæ‹¡å¤§ã€ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•å¯èƒ½ã€‚
4. ãƒ”ãƒ³ãƒã‚¤ãƒ³ã§ 1x æœªæº€ã«æˆ»ã‚‹ã¨è‡ªå‹•çš„ã«åŸç‚¹ã¸ã‚¹ãƒŠãƒƒãƒ—ã€‚
5. å³æ–¹å‘ã‚¹ãƒ¯ã‚¤ãƒ— (>100pt) ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ‚äº†ã—ã€å…ƒã®ã‚µãƒ ãƒã‚¤ãƒ«ä½ç½®ã«æˆ»ã‚‹ã€‚
6. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³:
   - å˜æ•°ç”»åƒ â†’ å³ä¿å­˜ã€ãƒˆãƒ¼ã‚¹ãƒˆ / ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã€‚(â€»å®Ÿè£…ã«ã‚ˆã‚‹)
   - è¤‡æ•°ç”»åƒ â†’ "n ä»¶ã™ã¹ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ" ã‚¢ãƒ©ãƒ¼ãƒˆã€‚
7. ç«¯æœ«ã®å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç”»åƒãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

## 12. ãƒ‡ãƒ¥ã‚¢ãƒ«ã‚«ãƒ¡ãƒ©åŒæ™‚æ’®å½±æ©Ÿèƒ½ â€• ãƒ•ãƒ­ãƒ³ãƒˆï¼‹ãƒªã‚¢åŒæ™‚éŒ²ç”»

### 12.1 æ©Ÿèƒ½æ¦‚è¦

- **ç›®çš„**: ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ãƒãƒ¼ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã€ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã¨ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã« PIP è¡¨ç¤ºã—ãªãŒã‚‰åŒæ™‚éŒ²ç”»ã—ã€1 æœ¬ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (HEVC `.mov`) ã«åˆæˆã™ã‚‹ã€‚éŒ²ç”»å®Œäº†å¾Œã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã¸é·ç§»ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œé€ä¿¡ã€ã¾ãŸã¯ã€Œé–‰ã˜ã‚‹ã€ã‚’é¸æŠã§ãã‚‹ (é–‰ã˜ã‚‹æ™‚ã¯ä¿å­˜æœ‰ç„¡ã‚’ç¢ºèª)ã€‚
- **å¯¾è±¡ OS / ãƒ‡ãƒã‚¤ã‚¹**: iOS 17 ä»¥é™ã€A12 Bionic ä»¥ä¸Šã§ _`AVCaptureMultiCamSession.isMultiCamSupported == true`_ ã®ç«¯æœ«ã€‚
- **ç‰¹å¾´**:
  1. _AVCaptureMultiCamSession_ ã«ã‚ˆã‚‹ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åŒæ™‚æ’®å½± (è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦)ã€‚
  2. Metal (ã‚‚ã—ãã¯ CoreImage) ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆæˆã—ã€_AVAssetWriter_ ã§å˜ä¸€ãƒˆãƒ©ãƒƒã‚¯ã¸ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€‚
  3. ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ã€Œé€ä¿¡ã€ã‚’é¸æŠã™ã‚‹ã¨å†™çœŸã‚¢ãƒ—ãƒªã¸ä¿å­˜ã—ã€ãƒãƒ£ãƒƒãƒˆã«æ·»ä»˜ (isSent=false)ã€‚
  4. ãƒ”ã‚¯ãƒãƒ£-ã‚¤ãƒ³-ãƒ”ã‚¯ãƒãƒ£ (èƒŒé¢: å…¨ç”»é¢ / å‰é¢: å³ä¸Š 160Ã—213px) ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆæœŸå€¤ã¨ã—ã€\*ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã‚¢ã‚¤ã‚³ãƒ³\*ã§ 2 ã¤ã®æ˜ åƒã‚µã‚¤ã‚ºã‚’ç¬æ™‚ã«åè»¢ã€‚
  5. å†…è”µãƒã‚¤ã‚¯ã‹ã‚‰ AAC 48kHz ã‚¹ãƒ†ãƒ¬ã‚ªéŒ²éŸ³ã—ã€ãƒ“ãƒ‡ã‚ªã¨åŒæœŸã€‚

### 12.2 UI å¤‰æ›´ç‚¹

| ç”»é¢             | è¿½åŠ ï¼å¤‰æ›´                                                             |
| ---------------- | ---------------------------------------------------------------------- |
| ChatView         | é€ä¿¡ãƒãƒ¼å·¦ã« `CameraDualIcon` (camera.fill.badge.plus) ã‚’è¿½åŠ           |
| DualCamModalView | å…¨ç”»é¢ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  PIP ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + éŒ²ç”»ãƒœã‚¿ãƒ³ãƒ»ã‚¿ã‚¤ãƒãƒ¼ãƒ»ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ |
| VideoReviewView  | éŒ²ç”»å¾Œã®å†ç”Ÿãƒ»ã€Œé€ä¿¡ã€ãƒ»ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³                               |

```swift
struct CameraDualButton: View {
    @State private var showRecorder = false
    var body: some View {
        Button {
            showRecorder = true
        } label: {
            Image(systemName: "camera.fill.badge.plus")
        }
        .fullScreenCover(isPresented: $showRecorder) {
            DualCamRecorderView()
        }
    }
}
```

### 12.3 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
flowchart TD
    A[DualCamRecorderView] --> B[DualCameraRecorder]
    B --> C1[AVCaptureMultiCamSession]
    B --> C2[VideoFrameMixer (Metal)]
    C2 --> D[AVAssetWriter]
```

- **DualCamRecorderView**: SwiftUI, ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒ»UI æ“ä½œã€‚
- **DualCameraRecorder (ObservableObject)**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»éŒ²ç”»åˆ¶å¾¡ã€‚`@Published var previewImage: CGImage?` ã‚’ Combine ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã€‚
- **VideoFrameMixer**: `CMSampleBuffer` 2 ç³»çµ±ã‚’ Metal ã‚·ã‚§ãƒ¼ãƒ€ã§åˆæˆã€‚é…å»¶ â‰¤16ms ã‚’ç›®æ¨™ã€‚

### 12.4 éŒ²ç”»ãƒ•ãƒ­ãƒ¼

1. `start()`
   - æ¨©é™ãƒã‚§ãƒƒã‚¯ / å–å¾— (`AVCaptureDevice.requestAccess`)ã€‚
   - `AVCaptureMultiCamSession` æ§‹ç¯‰: _backWide_ + _frontWide_ å…¥åŠ›ã€‚
   - å„å…¥åŠ›ã« `AVCaptureVideoDataOutput` ã‚’æ¥ç¶šã—ã€`setSampleBufferDelegate` ã§å–å¾—ã€‚
   - `VideoFrameMixer` ã¸æ¸¡ã—ã€åˆæˆ `CVPixelBuffer` ã‚’ `AVAssetWriterInputPixelBufferAdaptor` ã«æŠ•å…¥ã€‚
2. `stop()`
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ â†’ _AVAssetWriter.finishWriting_ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ **ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**ã« `.mov` ã‚’å‡ºåŠ›ã€‚
   - `VideoReviewView(tempURL)` ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã—ã€å†ç”Ÿãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã€‚
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ:
     - ã€Œé€ä¿¡ã€: `PHPhotoLibrary.shared().performChanges` ã§ä¿å­˜ â†’ `Message(body:"video://<localIdentifier>")` ã‚’æŒ¿å…¥ (`isSent=false`)ã€‚
     - ã€Œé–‰ã˜ã‚‹ã€: ã‚¢ãƒ©ãƒ¼ãƒˆ "ã“ã®å‹•ç”»ã‚’ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ" â†’ YES ã§ä¿å­˜ã€NO ã§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã€‚

### 12.5 ãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜

| é …ç›®       | å€¤                            |
| ---------- | ----------------------------- |
| ã‚³ãƒ³ãƒ†ãƒŠ   | ISO BMFF (`.mov`)             |
| ãƒ“ãƒ‡ã‚ª     | H.265/HEVC, 1920Ã—1080@30      |
| ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª | AAC 48kHz Stereo (å†…è”µãƒã‚¤ã‚¯) |
| ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ | orientation / location        |

### 12.6 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

- _isMultiCamSupported == false_ â†’ ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã—å˜ä¸€ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (èƒŒé¢ã®ã¿)ã€‚
- ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¤±æ•—æ™‚ â†’ ãƒ•ã‚¡ã‚¤ãƒ«ç ´æ£„ & ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã€ŒéŒ²ç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€ã€‚

### 12.7 Info.plist è¿½åŠ ã‚­ãƒ¼

| Key                                      | Value                                    |
| ---------------------------------------- | ---------------------------------------- |
| NSCameraUsageDescription                 | "å‹•ç”»æ’®å½±ã«ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¾ã™"           |
| NSMicrophoneUsageDescription             | "ãƒ‡ãƒ¥ã‚¢ãƒ«ã‚«ãƒ¡ãƒ©å‹•ç”»ã«ãƒã‚¤ã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™" |
| NSSaveToCameraRollUsageDescription (17+) | "æ’®å½±ã—ãŸå‹•ç”»ã‚’ã‚¢ãƒ«ãƒãƒ ã«ä¿å­˜ã—ã¾ã™"     |

### 12.8 ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (è¿½åŠ )

1. ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ãƒƒãƒ— â†’ ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã€‚
2. éŒ²ç”»é–‹å§‹ 5 ç§’ â†’ åœæ­¢ â†’ å†™çœŸã‚¢ãƒ—ãƒªã« 1 ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã•ã‚Œã‚‹ã€‚
3. ãƒãƒ£ãƒƒãƒˆã«å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«ãŒå³æ™‚è¡¨ç¤ºã•ã‚Œã‚‹ (isSent=false)ã€‚
4. é€ä¿¡å®Œäº†å¾Œã€ç›¸æ‰‹ç«¯æœ«ã§å†ç”Ÿå¯èƒ½ã€‚
5. ãƒ‡ãƒã‚¤ã‚¹ãŒ multi-cam éå¯¾å¿œã®å ´åˆã€èƒŒé¢ã®ã¿ã§éŒ²ç”»å¯èƒ½ã€‚
6. ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§é–‰ã˜ã‚‹ â†’ ä¿å­˜ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€é¸æŠã«å¿œã˜ã¦ä¿å­˜ï¼ç ´æ£„ã•ã‚Œã‚‹ã€‚

## 13. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â€• â€œInstagram-Likeâ€ çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### 13.1 UX ãƒ•ãƒ­ãƒ¼

| ãƒ•ã‚§ãƒ¼ã‚º          | æŒ‡ã®çŠ¶æ…‹        | ç”»é¢æŒ™å‹•                                                                                  | å‚™è€ƒ                                  |
| ----------------- | --------------- | ----------------------------------------------------------------------------------------- | ------------------------------------- | ---------------------------- | -------------- |
| A. é–‹å§‹           | é•·æŠ¼ã— 0.35s    | â€¢ ãƒ”ãƒƒã‚«ãƒ¼ `spring+fade-in` ã§å‡ºç¾<br>â€¢ ãƒªã‚¹ãƒˆ `scrollDisabled(true)`<br>â€¢ Haptic `.soft` | `.sequencedGesture` ã§ LongPressâ†’Drag |
| B. é¸æŠ           | æŒ‡ã‚’å·¦å³ Drag   | â€¢ X ä½ç½® â†’ index<br>â€¢ å¯¾è±¡çµµæ–‡å­— `scale 1.4` + Bold<br>â€¢ Index å¤‰åŒ–æ¯ã« Haptic `.light`   | `GestureState` ã§ç›£è¦–                 |
| C. ã‚­ãƒ£ãƒ³ã‚»ãƒ«æº–å‚™ | æŒ‡ã‚’ä¸Šä¸‹ Â±150pt | ä¸é€æ˜åº¦ `1-min(                                                                          | Î”Y                                    | /150,0.8)`                   | 0.2 ã¾ã§ã¯æ®‹ã™ |
| D. ç¢ºå®š/å–æ¶ˆ      | æŒ‡ã‚’é›¢ã™        |                                                                                           | Î”Y                                    | <60 â†’ ç¢ºå®šï¼â‰¥60 â†’ ã‚­ãƒ£ãƒ³ã‚»ãƒ« |                |

### 13.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
MessageBubble
â””â”€ .popover(ReactionPickerView)
    â”œâ”€ HStack(EmojiItem)
    â””â”€ DragGesture(minDistance:0)
```

_MessageBubble_ ã§ã¯ `.popover` ã‚’ä½¿ç”¨ã—ã€ãƒãƒ–ãƒ«ç›´ä¸Šã«æ·»ä»˜ã€‚è¡¨ç¤ºæ™‚ã¯ `scrollLocked = true`ã€‚

### 13.3 ReactionPickerView.swiftï¼ˆæŠœç²‹ï¼‰

```swift
GeometryReader { geo in
    HStack(spacing: 20) {
        ForEach(items.indices, id: \.self) { idx in
            itemView(idx)
                .scaleEffect(idx == index ? 1.4 : 1)
                .animation(.easeInOut(duration: 0.08), value: index)
        }
    }
    .opacity(opacity(for: drag.height))
    .gesture(
        DragGesture(minimumDistance: 0)
            .updating($drag) { v, s, _ in s = v.translation }
            .onChanged { updateHighlight(x: $0.location.x, width: geo.size.width) }
            .onEnded   { finish($0, geo: geo) }
    )
}
.frame(height: 60)
```

### 13.4 çŠ¶æ…‹ç®¡ç†

```swift
@Observable final class ChatUIState {
    var reactingMsgID: UUID? = nil
    var scrollLocked  = false
}
```

å„ View ã¯ `environment(chatUIState)` ã‚’æ³¨å…¥ã€‚

### 13.5 ãƒ‡ãƒ¼ã‚¿æ›¸è¾¼

_ç¢ºå®š_: `message.reactionEmoji = emoji` â†’ `CKSync.saveReaction(_)`

_ï¼‹_: ãƒ•ãƒ«çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ `.sheet` èµ·å‹•

_ã‚­ãƒ£ãƒ³ã‚»ãƒ«_: ä½•ã‚‚ã—ãªã„

### 13.6 ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ & Haptic

| ã‚¿ã‚¤ãƒŸãƒ³ã‚° | API                                                                                          |
| ---------- | -------------------------------------------------------------------------------------------- |
| å‡ºç¾/æ¶ˆå¤±  | `.transition(.scale.combined(with:.opacity))` + `.spring(response:0.35,dampingFraction:0.8)` |
| Index å¤‰æ›´ | `UIImpactFeedbackGenerator(style:.light)`                                                    |

### 13.7 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´

ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤ºä¸­ã¯

```swift
.padding(.top, 60).padding(.bottom, 60)
.scrollDisabled(true)
```

ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„å…¥åŠ›æ¬„ã«è¢«ã‚‰ãªã„ã€‚

### 13.8 ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

1. é•·æŠ¼ã— â†’ ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤º & ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢
2. å·¦å³ Drag ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ & Haptic
3. ä¸Šä¸‹ Drag ã§é€é
4. 60pt æœªæº€ã§ç¢ºå®šã€ä»¥ä¸Šã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
5. ï¼‹ é¸æŠã§ãƒ•ãƒ«ãƒ”ãƒƒã‚«ãƒ¼
6. ãƒãƒ–ãƒ«å³ä¸‹ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
7. recentEmojis ãŒ LRU æ›´æ–°
8. UI ãŒãƒ˜ãƒƒãƒ€ãƒ¼/å…¥åŠ›æ¬„ã«è¢«ã‚‰ãªã„

---

### 13.9 å®Ÿè£…è¨­è¨ˆï¼ˆiOS 17+ï¼‰

> GetStream / Like-Reactions-Button ã®å®Ÿè£…ã¯å‚è€ƒã«ç•™ã‚ã€SwiftUI ã®æœ€æ–° API ã‚’ãƒ•ãƒ«æ´»ç”¨ã—ã¦ã‚¼ãƒ­ãƒ™ãƒ¼ã‚¹ã§æ§‹ç¯‰ã™ã‚‹æ–¹é‡ã€‚

#### 1) åŸºæœ¬è¨­è¨ˆ

- **è¡¨ç¤ºçµµæ–‡å­—æ•°**: æœ€è¿‘ä½¿ã£ãŸ 3 ã¤ + ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã®ã¿ï¼ˆè¨ˆ 4 ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
- **ä»»æ„é¸æŠ**: ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—æ™‚ã¯æ—¢å­˜ã® `MCEmojiPickerSheet` ã‚’æµç”¨
- **å¯¾è±¡ OS**: iOS 17 ä»¥ä¸Šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…ã¯ä¸è¦ï¼‰

#### 2) çŠ¶æ…‹ç®¡ç†

```swift
@Observable
final class ReactionStore {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    var reactions: [UUID: String] = [:]

    // æœ€è¿‘ä½¿ã£ãŸçµµæ–‡å­—ï¼ˆæœ€å¤§3ã¤ï¼‰
    @AppStorage("recentReactionEmojis")
    var recentEmojis: String = "ğŸ‘,â¤ï¸,ğŸ˜‚"

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
    var reactingMessageID: UUID? = nil

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    var highlightedIndex: Int = 0

    // ä¸Šä¸‹ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚‹é€æ˜åº¦
    var opacity: Double = 1.0

    func addReaction(_ emoji: String, to messageID: UUID) {
        reactions[messageID] = emoji
        updateRecentEmojis(with: emoji)
    }

    private func updateRecentEmojis(with emoji: String) {
        var recent = recentEmojis.split(separator: ",").map(String.init)
        recent.removeAll { $0 == emoji }
        recent.insert(emoji, at: 0)
        recentEmojis = recent.prefix(3).joined(separator: ",")
    }
}
```

#### 3) ãƒ“ãƒ¥ãƒ¼æ§‹æˆ

```swift
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«
MessageBubble
â”œâ”€ .onLongPressGesture { store.reactingMessageID = message.id }
â””â”€ .popover(isPresented: .constant(store.reactingMessageID == message.id),
            attachmentAnchor: .point(.top)) {
     ReactionPickerView()
         .presentationCompactAdaptation(.none)
   }
```

#### 4) ReactionPickerView å®Ÿè£…

```swift
struct ReactionPickerView: View {
    @Environment(ReactionStore.self) private var store
    @GestureState private var dragTranslation: CGSize = .zero
    @State private var showEmojiPicker = false

    private var recentEmojis: [String] {
        store.recentEmojis.split(separator: ",").map(String.init)
    }

    var body: some View {
        HStack(spacing: 20) {
            // æœ€è¿‘ä½¿ã£ãŸçµµæ–‡å­—
            ForEach(Array(recentEmojis.enumerated()), id: \.offset) { index, emoji in
                Text(emoji)
                    .font(.system(size: 28))
                    .scaleEffect(store.highlightedIndex == index ? 1.3 : 1.0)
                    .animation(.spring(response: 0.3, dampingFraction: 0.7),
                              value: store.highlightedIndex)
            }

            // ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³
            Image(systemName: "plus.circle")
                .font(.system(size: 24))
                .foregroundStyle(.secondary)
                .scaleEffect(store.highlightedIndex == 3 ? 1.3 : 1.0)
                .animation(.spring(response: 0.3, dampingFraction: 0.7),
                          value: store.highlightedIndex)
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 12)
        .background(.ultraThinMaterial)
        .clipShape(Capsule())
        .opacity(store.opacity)
        .gesture(reactionGesture)
        .sheet(isPresented: $showEmojiPicker) {
            MCEmojiPickerSheet { selectedEmoji in
                if let messageID = store.reactingMessageID {
                    store.addReaction(selectedEmoji, to: messageID)
                }
                store.reactingMessageID = nil
            }
        }
    }

    private var reactionGesture: some Gesture {
        DragGesture(minimumDistance: 0)
            .updating($dragTranslation) { value, state, _ in
                state = value.translation
            }
            .onChanged { value in
                // æ¨ªä½ç½®ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                updateHighlight(at: value.location)

                // ç¸¦ç§»å‹•ã§é€æ˜åº¦ã‚’èª¿æ•´
                let absY = abs(value.translation.height)
                store.opacity = max(0.2, 1 - (absY / 150))
            }
            .onEnded { value in
                let absY = abs(value.translation.height)

                if absY > 60 {
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    store.reactingMessageID = nil
                } else {
                    // é¸æŠç¢ºå®š
                    confirmSelection()
                }

                // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                store.opacity = 1.0
                store.highlightedIndex = 0
            }
    }

    private func updateHighlight(at location: CGPoint) {
        // ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‹ã‚‰é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        // å®Ÿè£…è©³ç´°ã¯çœç•¥
    }

    private func confirmSelection() {
        guard let messageID = store.reactingMessageID else { return }

        if store.highlightedIndex < recentEmojis.count {
            // çµµæ–‡å­—é¸æŠ
            let emoji = recentEmojis[store.highlightedIndex]
            store.addReaction(emoji, to: messageID)
            store.reactingMessageID = nil

            // Haptic feedback
            UIImpactFeedbackGenerator(style: .light).impactOccurred()
        } else if store.highlightedIndex == 3 {
            // ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³
            showEmojiPicker = true
        }
    }
}
```

#### 5) ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è©³ç´°

- **å‡ºç¾**: `.popover` ã®è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨
- **ãƒã‚¤ãƒ©ã‚¤ãƒˆ**: `spring(response: 0.3, dampingFraction: 0.7)` ã§è‡ªç„¶ãªå‹•ã
- **é€æ˜åº¦å¤‰åŒ–**: `opacity = max(0.2, 1 - (|Î”Y| / 150))` ã§ 0.2 ã¾ã§
- **Haptic**: é¸æŠæ™‚ã« `.light` ã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

#### 6) ChatView ã§ã®çµ±åˆ

```swift
struct ChatView: View {
    @Environment(ReactionStore.self) private var reactionStore

    var body: some View {
        ScrollView {
            LazyVStack {
                ForEach(messages) { message in
                    MessageBubbleView(message: message)
                        .overlay(alignment: .bottomTrailing) {
                            if let reaction = reactionStore.reactions[message.id] {
                                Text(reaction)
                                    .font(.system(size: 16))
                                    .padding(4)
                                    .background(Circle().fill(.thinMaterial))
                                    .transition(.scale.combined(with: .opacity))
                            }
                        }
                }
            }
        }
        .scrollDisabled(reactionStore.reactingMessageID != nil)
    }
}
```

#### 7) å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

- **ã‚·ãƒ³ãƒ—ãƒ«ã•é‡è¦–**: 4 ã¤ã®ãƒœã‚¿ãƒ³ã®ã¿ãªã®ã§è¤‡é›‘ãªæœ€é©åŒ–ã¯ä¸è¦
- **æ—¢å­˜è³‡ç”£ã®æ´»ç”¨**: `MCEmojiPickerSheet` ã¨ `QuickEmojiBar` ã®çµµæ–‡å­—ã‚’å…±æœ‰
- **ä¸€è²«æ€§**: å…¥åŠ›æ¬„ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§åŒã˜æœ€è¿‘ä½¿ã£ãŸçµµæ–‡å­—ã‚’ä½¿ç”¨
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: VoiceOver ã§ã®çµµæ–‡å­—èª­ã¿ä¸Šã’ã«å¯¾å¿œ

#### 8) ãƒ†ã‚¹ãƒˆé …ç›®

1. é•·æŠ¼ã— â†’ ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤ºã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢
2. å·¦å³ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ‡ã‚Šæ›¿ãˆã¨ Haptic
3. ä¸Šä¸‹ 60pt ä»¥ä¸Šã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€æœªæº€ã§é¸æŠç¢ºå®š
4. ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã§ `MCEmojiPickerSheet` è¡¨ç¤º
5. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµµæ–‡å­—ãŒãƒãƒ–ãƒ«å³ä¸‹ã«è¡¨ç¤º
6. æœ€è¿‘ä½¿ã£ãŸçµµæ–‡å­—ã®æ›´æ–°ã¨æ°¸ç¶šåŒ–

ã“ã‚Œã«ã‚ˆã‚Šã€Instagram é¢¨ã®æµä½“çš„ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä½“é¨“ã‚’ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ä¿å®ˆã—ã‚„ã™ã„å®Ÿè£…ã§å®Ÿç¾ã—ã¾ã™ã€‚
